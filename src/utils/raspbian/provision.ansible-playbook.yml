
hosts: all
 become: yes
      tasks:
- name: Install Docker
apt:
name: docker.io
state: present

- name: Install Kubernetes components
apt:
name: '{{ item }}'
state: present
       loop:
                  - kubelet
                             - kubeadm
                                        - kubectl

                                           - hosts: pc0
                                                tasks:
                                                       - name: Stop kubelet service, reload daemon, and reset kubeadm
                                                                shell: |
                                                                           sudo systemctl stop kubelet.service
                                                                                    sudo systemctl daemon-reload
                                                                                             sudo kubeadm reset

                                                                                                  - name: Backup kube config and generate token
                                                                                                           shell: |
                                                                                                                      mv ~/.kube/config ~/.kube/config.bak
                                                                                                                               TOKEN=$(sudo kubeadm token generate)
                                                                                                                                        echo "TOKEN={{ TOKEN }}" > /tmp/token.yml

                                                                                                                                             - name: Initialize Kubernetes cluster on pc0
                                                                                                                                                      shell: |
                                                                                                                                                                 sudo kubeadm init --token=${TOKEN} --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=Mem
                                                                                                                                                                          sudo cp -i /etc/kubernetes/admin.conf /home/picocluster/.kube/config
                                                                                                                                                                                   sudo chown $(id -u):$(id -g) /home/picocluster/.kube/config
                                                                                                                                                                                            CERT_HASH=$(sudo kubeadm init phase upload-certs --upload-certs | awk '/tls.crt:/{print $2}')
                                                                                                                                                                                                     echo "CERT_HASH={{ CERT_HASH }}" > /tmp/cert_hash.yml

                                                                                                                                                                                                          - name: Save TOKEN for pc1 and pc2
                                                                                                                                                                                                                   shell: echo "CERT_HASH={{ CERT_HASH }}" > /tmp/cert_hash.yml
                                                                                                                                                                                                                            delegate_to: localhost

                                                                                                                                                                                                                                   - name: Copy token and cert_hash files to pc1 and pc2
                                                                                                                                                                                                                                            copy:
                                                                                                                                                                                                                                                       src: "/tmp/token.yml"
                                                                                                                                                                                                                                                                  dest: "/tmp/token.yml"
                                                                                                                                                                                                                                                                           delegate_to: pc1

                                                                                                                                                                                                                                                                                                                                              copy:
                                                                                                                                                                                                                                                                                                                                                                                       src: "/tmp/cert_hash.yml"
                                                                                                                                                                                                                                                                                                                                                                                                  dest: "/tmp/cert_hash.yml"
                                                                                                                                                                                                                                                                                                                                                                                                           delegate_to: pc1

                                                                                                                                                                                                                                                                                                                                                                                                                    copy:
                                                                                                                                                                                                                                                                                                                                                                                                                               src: "/tmp/token.yml"
                                                                                                                                                                                                                                                                                                                                                                                                                                          dest: "/tmp/token.yml"
                                                                                                                                                                                                                                                                                                                                                                                                                                                   delegate_to: pc2

                                                                                                                                                                                                                                                                                                                                                                                                                                                            copy:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       src: "/tmp/cert_hash.yml"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  dest: "/tmp/cert_hash.yml"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           delegate_to: pc2

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - hosts: pc1, pc2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   tasks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - name: Join pc1 and pc2 to Kubernetes cluster
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   shell: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              source /tmp/token.yml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       source /tmp/cert_hash.yml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sudo kubeadm join 192.168.1.240:6443 --token $TOKEN --discovery-token-ca-cert-hash $CERT_HASH

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 - hosts: pc0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      tasks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             - name: Apply Kubernetes manifest files on pc0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      shell: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # Add here the commands to apply Kubernetes files on pc0a
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     kubectl apply -f ~/Projects/dashboard/dashboard-adminuser.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              kubectl apply -f ~/Projects/dashboard/recommended.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       kubectl apply -f ~/Projects/helm/rbac-config.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                kubectl apply -f ~/Projects/home-assistant/deployment.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         kubectl apply -f ~/Projects/home-assistant/persistent-volume.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  kubectl apply -f ~/Projects/home-assistant/service.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           kubectl apply -f ~/Projects/metallb/metallb-namespace.yml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    kubectl apply -f ~/Projects/monitoring/promtail-daemonset.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             kubectl apply -f ~/Projects/monitoring/pushgateway.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      kubectl apply -f ~/Projects/monitoring/telegraf-pc2.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               kubectl apply -f ~/Projects/nginx/deployment/nginx.deployment.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        kubectl apply -f ~/Projects/nginx/ingress/bare-metal-nginx-deploy.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 kubectl apply -f ~/Projects/nginx/ingress/dashboard-ingress.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          kubectl apply -f ~/Projects/nginx/ingress/home-assistant-ingress.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   kubectl apply -f ~/Projects/nginx/ingress/ingress-controller.yml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            kubectl apply -f ~/Projects/nginx/ingress/pihole-ingress.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     kubectl apply -f ~/Projects/pihole/pihole.yaml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              kubectl apply -f ~/Projects/sthinds.io/k8s.yml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       kubectl apply -f ~/Projects/trello-groomer/trello-groomer.deploy.yml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                kubectl apply -f ~/Projects/tts-ui/k8s-deploy.yml